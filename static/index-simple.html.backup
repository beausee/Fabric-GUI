<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fabric GUI - Enhanced</title>
  <style>
    * { box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      margin: 0;
      padding: 0;
      background: #0f172a;
      color: #e2e8f0;
    }

    header {
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      padding: 1.5rem 2rem;
      border-bottom: 2px solid #334155;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }

    h1 {
      margin: 0 0 0.5rem 0;
      font-size: 2rem;
      background: linear-gradient(135deg, #22d3ee 0%, #a78bfa 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .subtitle {
      color: #94a3b8;
      font-size: 0.95rem;
    }

    main {
      max-width: 1800px;
      margin: 0 auto;
      padding: 2rem;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
    }

    .panel {
      background: #1e293b;
      border-radius: 12px;
      padding: 1.5rem;
      border: 1px solid #334155;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    }

    .full-width {
      grid-column: 1 / -1;
    }

    h2 {
      margin: 0 0 1rem 0;
      font-size: 1.4rem;
      color: #22d3ee;
    }

    h3 {
      margin: 1.5rem 0 0.75rem 0;
      font-size: 1.1rem;
      color: #a78bfa;
    }

    label {
      display: block;
      margin: 0.75rem 0 0.4rem 0;
      font-size: 0.9rem;
      color: #cbd5e1;
      font-weight: 500;
    }

    input, select, textarea {
      width: 100%;
      padding: 0.6rem 0.8rem;
      border-radius: 8px;
      border: 1px solid #475569;
      background: #0f172a;
      color: #e2e8f0;
      font-family: inherit;
      font-size: 0.95rem;
      transition: all 0.2s;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #22d3ee;
      box-shadow: 0 0 0 3px rgba(34, 211, 238, 0.1);
    }

    textarea {
      font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
      resize: vertical;
      min-height: 120px;
    }

    select {
      cursor: pointer;
    }

    button {
      padding: 0.7rem 1.5rem;
      border-radius: 8px;
      border: none;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-right: 0.5rem;
      margin-top: 0.5rem;
    }

    .btn-primary {
      background: linear-gradient(135deg, #22d3ee 0%, #06b6d4 100%);
      color: #0f172a;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(34, 211, 238, 0.4);
    }

    .btn-secondary {
      background: #475569;
      color: #e2e8f0;
    }

    .btn-secondary:hover {
      background: #64748b;
    }

    .btn-success {
      background: #10b981;
      color: white;
    }

    .btn-success:hover {
      background: #059669;
    }

    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      border-bottom: 2px solid #334155;
    }

    .tab {
      padding: 0.7rem 1.2rem;
      background: transparent;
      color: #94a3b8;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-size: 0.95rem;
      transition: all 0.2s;
      margin: 0;
    }

    .tab.active {
      color: #22d3ee;
      border-bottom-color: #22d3ee;
    }

    .tab:hover {
      color: #e2e8f0;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    pre {
      background: #0f172a;
      padding: 1rem;
      border-radius: 8px;
      overflow-x: auto;
      font-size: 0.85rem;
      border: 1px solid #334155;
      max-height: 500px;
      overflow-y: auto;
      font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
    }

    .status {
      padding: 0.75rem;
      border-radius: 8px;
      margin-top: 1rem;
      font-size: 0.9rem;
    }

    .status-info {
      background: rgba(34, 211, 238, 0.1);
      color: #22d3ee;
      border: 1px solid #22d3ee;
    }

    .status-success {
      background: rgba(16, 185, 129, 0.1);
      color: #10b981;
      border: 1px solid #10b981;
    }

    .status-error {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
      border: 1px solid #ef4444;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin: 0.75rem 0;
    }

    .checkbox-group input[type="checkbox"] {
      width: auto;
      margin: 0;
    }

    .checkbox-group label {
      margin: 0;
    }

    .small {
      font-size: 0.85rem;
      color: #94a3b8;
    }

    .search-input {
      margin-bottom: 0.5rem;
    }

    .pattern-desc {
      background: #0f172a;
      padding: 0.75rem;
      border-radius: 6px;
      margin-top: 0.5rem;
      font-size: 0.85rem;
      color: #94a3b8;
      border-left: 3px solid #22d3ee;
    }

    .loader {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 3px solid rgba(34, 211, 238, 0.3);
      border-top-color: #22d3ee;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .output-actions {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .collapsible {
      cursor: pointer;
      user-select: none;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .collapsible::before {
      content: '▼';
      font-size: 0.8rem;
      transition: transform 0.2s;
    }

    .collapsible.collapsed::before {
      transform: rotate(-90deg);
    }

    .command-preview {
      background: #0f172a;
      padding: 1rem;
      border-radius: 8px;
      font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
      font-size: 0.85rem;
      color: #22d3ee;
      border: 1px solid #334155;
      margin-top: 1rem;
      word-wrap: break-word;
    }
  </style>
</head>
<body>
  <header>
    <h1>Fabric GUI</h1>
    <div class="subtitle">Enhanced interface for Fabric AI Framework - 233+ Patterns Available</div>
  </header>

  <main>
    <!-- Left Column: Input & Configuration -->
    <div class="panel">
      <h2>Pattern & Configuration</h2>

      <label for="patternSelect">Pattern</label>
      <input type="text" id="patternSearch" class="search-input" placeholder="Search patterns...">
      <select id="patternSelect" size="8">
        <option value="">Loading patterns...</option>
      </select>
      <div id="patternDesc" class="pattern-desc" style="display:none;"></div>

      <div class="grid-2">
        <div>
          <label for="modelSelect">Model</label>
          <select id="modelSelect">
            <option value="">Default Model</option>
          </select>
        </div>
        <div>
          <label for="vendorSelect">Vendor</label>
          <select id="vendorSelect">
            <option value="">Auto</option>
          </select>
        </div>
      </div>

      <div class="grid-2">
        <div>
          <label for="contextSelect">Context</label>
          <select id="contextSelect">
            <option value="">None</option>
          </select>
        </div>
        <div>
          <label for="sessionSelect">Session</label>
          <select id="sessionSelect">
            <option value="">None</option>
          </select>
        </div>
      </div>

      <h3 class="collapsible" onclick="toggleSection('advancedOptions')">Advanced Options</h3>
      <div id="advancedOptions" style="display:none;">
        <label for="temperature">Temperature (0.0 - 2.0)</label>
        <input type="number" id="temperature" min="0" max="2" step="0.1" placeholder="0.7">

        <div class="checkbox-group">
          <input type="checkbox" id="streamCheck">
          <label for="streamCheck">Stream output</label>
        </div>

        <div class="checkbox-group">
          <input type="checkbox" id="copyCheck">
          <label for="copyCheck">Copy to clipboard</label>
        </div>

        <div class="checkbox-group">
          <input type="checkbox" id="searchCheck">
          <label for="searchCheck">Enable web search</label>
        </div>

        <div class="checkbox-group">
          <input type="checkbox" id="dryRunCheck">
          <label for="dryRunCheck">Dry run (preview only)</label>
        </div>
      </div>
    </div>

    <!-- Right Column: Input Methods -->
    <div class="panel">
      <h2>Input</h2>

      <div class="tabs">
        <button class="tab active" onclick="switchTab('text')">Text</button>
        <button class="tab" onclick="switchTab('url')">URL</button>
        <button class="tab" onclick="switchTab('youtube')">YouTube</button>
        <button class="tab" onclick="switchTab('raw')">Raw CLI</button>
      </div>

      <div id="tab-text" class="tab-content active">
        <label for="inputText">Text Input</label>
        <textarea id="inputText" placeholder="Enter your text here..."></textarea>
      </div>

      <div id="tab-url" class="tab-content">
        <label for="inputUrl">URL to Process</label>
        <input type="url" id="inputUrl" placeholder="https://example.com/article">
        <div class="small">Uses Jina AI to scrape and convert to markdown</div>
      </div>

      <div id="tab-youtube" class="tab-content">
        <label for="youtubeUrl">YouTube URL</label>
        <input type="url" id="youtubeUrl" placeholder="https://youtube.com/watch?v=...">
        <div class="small">Extracts transcript from video</div>
      </div>

      <div id="tab-raw" class="tab-content">
        <label for="rawArgs">Raw CLI Arguments</label>
        <textarea id="rawArgs" placeholder='-p "extract_wisdom" --model gpt-4'></textarea>
        <div class="small">For advanced users: pass raw arguments to fabric CLI</div>
      </div>

      <div class="command-preview">
        <strong>Command Preview:</strong><br>
        <span id="commandPreview">fabric</span>
      </div>

      <div style="margin-top: 1rem;">
        <button class="btn-primary" onclick="runFabric()">Run Pattern</button>
        <button class="btn-secondary" onclick="clearAll()">Clear</button>
      </div>

      <div id="status"></div>
    </div>

    <!-- Full Width: Output -->
    <div class="panel full-width">
      <h2>Output</h2>

      <div class="output-actions">
        <button class="btn-success" onclick="copyOutput()">Copy Output</button>
        <button class="btn-secondary" onclick="downloadOutput()">Download</button>
      </div>

      <div class="tabs">
        <button class="tab active" onclick="switchOutputTab('stdout')">Result</button>
        <button class="tab" onclick="switchOutputTab('stderr')">Errors</button>
        <button class="tab" onclick="switchOutputTab('both')">Both</button>
      </div>

      <div id="output-stdout" class="tab-content active">
        <pre id="stdout">Output will appear here...</pre>
      </div>

      <div id="output-stderr" class="tab-content">
        <pre id="stderr">Errors will appear here...</pre>
      </div>

      <div id="output-both" class="tab-content">
        <h3>stdout:</h3>
        <pre id="stdout-both"></pre>
        <h3>stderr:</h3>
        <pre id="stderr-both"></pre>
      </div>
    </div>
  </main>

  <script>
    // Global state
    let patterns = [];
    let models = [];
    let vendors = [];
    let contexts = [];
    let sessions = [];
    let currentTab = 'text';
    let lastOutput = { stdout: '', stderr: '' };

    // Initialize
    async function init() {
      await Promise.all([
        loadPatterns(),
        loadModels(),
        loadVendors(),
        loadContexts(),
        loadSessions()
      ]);
      updateCommandPreview();
    }

    // Load data functions
    async function loadPatterns() {
      try {
        const resp = await fetch('/api/patterns');
        const data = await resp.json();
        patterns = data.patterns || [];
        populatePatternSelect();
      } catch (err) {
        console.error('Failed to load patterns:', err);
      }
    }

    async function loadModels() {
      try {
        const resp = await fetch('/api/models');
        const data = await resp.json();
        models = data.models || [];
        populateSelect('modelSelect', models, 'Default Model');
      } catch (err) {
        console.error('Failed to load models:', err);
      }
    }

    async function loadVendors() {
      try {
        const resp = await fetch('/api/vendors');
        const data = await resp.json();
        vendors = data.vendors || [];
        populateSelect('vendorSelect', vendors, 'Auto');
      } catch (err) {
        console.error('Failed to load vendors:', err);
      }
    }

    async function loadContexts() {
      try {
        const resp = await fetch('/api/contexts');
        const data = await resp.json();
        contexts = data.contexts || [];
        populateSelect('contextSelect', contexts, 'None');
      } catch (err) {
        console.error('Failed to load contexts:', err);
      }
    }

    async function loadSessions() {
      try {
        const resp = await fetch('/api/sessions');
        const data = await resp.json();
        sessions = data.sessions || [];
        populateSelect('sessionSelect', sessions, 'None');
      } catch (err) {
        console.error('Failed to load sessions:', err);
      }
    }

    // Populate selects
    function populateSelect(id, items, defaultLabel) {
      const select = document.getElementById(id);
      select.innerHTML = `<option value="">${defaultLabel}</option>`;
      items.forEach(item => {
        const option = document.createElement('option');
        option.value = item;
        option.textContent = item;
        select.appendChild(option);
      });
    }

    function populatePatternSelect() {
      const select = document.getElementById('patternSelect');
      select.innerHTML = '<option value="">Select a pattern...</option>';
      patterns.forEach(pattern => {
        const option = document.createElement('option');
        option.value = pattern;
        option.textContent = pattern;
        select.appendChild(option);
      });
    }

    // Pattern search
    document.getElementById('patternSearch').addEventListener('input', (e) => {
      const search = e.target.value.toLowerCase();
      const select = document.getElementById('patternSelect');

      Array.from(select.options).forEach(option => {
        if (option.value === '') return;
        const matches = option.value.toLowerCase().includes(search);
        option.style.display = matches ? '' : 'none';
      });
    });

    // Pattern selection
    document.getElementById('patternSelect').addEventListener('change', (e) => {
      const pattern = e.target.value;
      const desc = document.getElementById('patternDesc');

      if (pattern) {
        desc.style.display = 'block';
        desc.textContent = `Selected: ${pattern}`;
      } else {
        desc.style.display = 'none';
      }

      updateCommandPreview();
    });

    // Tab switching
    function switchTab(tab) {
      currentTab = tab;

      document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

      event.target.classList.add('active');
      document.getElementById(`tab-${tab}`).classList.add('active');

      updateCommandPreview();
    }

    function switchOutputTab(tab) {
      document.querySelectorAll('#output-stdout, #output-stderr, #output-both').forEach(t => {
        t.classList.remove('active');
      });
      document.querySelectorAll('.output-actions + .tabs .tab').forEach(t => {
        t.classList.remove('active');
      });

      event.target.classList.add('active');
      document.getElementById(`output-${tab}`).classList.add('active');
    }

    // Command preview
    function updateCommandPreview() {
      const preview = document.getElementById('commandPreview');
      let cmd = 'fabric';

      const pattern = document.getElementById('patternSelect').value;
      const model = document.getElementById('modelSelect').value;
      const vendor = document.getElementById('vendorSelect').value;
      const context = document.getElementById('contextSelect').value;
      const session = document.getElementById('sessionSelect').value;
      const temp = document.getElementById('temperature').value;

      if (pattern) cmd += ` -p "${pattern}"`;
      if (model) cmd += ` -m "${model}"`;
      if (vendor) cmd += ` -V "${vendor}"`;
      if (context) cmd += ` -C "${context}"`;
      if (session) cmd += ` --session "${session}"`;
      if (temp) cmd += ` -t ${temp}`;
      if (document.getElementById('streamCheck').checked) cmd += ' -s';
      if (document.getElementById('copyCheck').checked) cmd += ' -c';
      if (document.getElementById('searchCheck').checked) cmd += ' --search';
      if (document.getElementById('dryRunCheck').checked) cmd += ' --dry-run';

      if (currentTab === 'url') {
        const url = document.getElementById('inputUrl').value;
        if (url) cmd += ` -u "${url}"`;
      } else if (currentTab === 'youtube') {
        const url = document.getElementById('youtubeUrl').value;
        if (url) cmd += ` -y "${url}"`;
      } else if (currentTab === 'raw') {
        const raw = document.getElementById('rawArgs').value;
        if (raw) cmd = `fabric ${raw}`;
      }

      preview.textContent = cmd;
    }

    // Add listeners to update preview
    ['patternSelect', 'modelSelect', 'vendorSelect', 'contextSelect', 'sessionSelect', 'temperature',
     'streamCheck', 'copyCheck', 'searchCheck', 'dryRunCheck', 'inputUrl', 'youtubeUrl', 'rawArgs']
      .forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.addEventListener('change', updateCommandPreview);
          el.addEventListener('input', updateCommandPreview);
        }
      });

    // Run fabric
    async function runFabric() {
      const status = document.getElementById('status');
      const stdoutEl = document.getElementById('stdout');
      const stderrEl = document.getElementById('stderr');
      const stdoutBoth = document.getElementById('stdout-both');
      const stderrBoth = document.getElementById('stderr-both');

      status.innerHTML = '<span class="loader"></span> Running...';
      status.className = 'status status-info';

      stdoutEl.textContent = 'Processing...';
      stderrEl.textContent = '';

      try {
        let endpoint = '/api/pattern/run';
        let body = {};

        if (currentTab === 'raw') {
          // Use raw CLI endpoint
          endpoint = '/api/run';
          body = { args: document.getElementById('rawArgs').value };
        } else {
          // Use structured endpoint
          body = {
            pattern: document.getElementById('patternSelect').value || null,
            model: document.getElementById('modelSelect').value || null,
            vendor: document.getElementById('vendorSelect').value || null,
            context: document.getElementById('contextSelect').value || null,
            session: document.getElementById('sessionSelect').value || null,
            temperature: parseFloat(document.getElementById('temperature').value) || null,
            stream: document.getElementById('streamCheck').checked,
            copy: document.getElementById('copyCheck').checked,
            search: document.getElementById('searchCheck').checked,
            dry_run: document.getElementById('dryRunCheck').checked,
            input_text: currentTab === 'text' ? document.getElementById('inputText').value : null,
            input_url: currentTab === 'url' ? document.getElementById('inputUrl').value : null,
            youtube_url: currentTab === 'youtube' ? document.getElementById('youtubeUrl').value : null
          };
        }

        const resp = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        const data = await resp.json();

        if (!resp.ok) {
          status.textContent = 'Error: ' + (data.detail || 'Unknown error');
          status.className = 'status status-error';
          return;
        }

        lastOutput = { stdout: data.stdout || '', stderr: data.stderr || '' };

        stdoutEl.textContent = data.stdout || '(no output)';
        stderrEl.textContent = data.stderr || '(no errors)';
        stdoutBoth.textContent = data.stdout || '(no output)';
        stderrBoth.textContent = data.stderr || '(no errors)';

        const success = data.returncode === 0;
        status.textContent = success
          ? `✓ Success! Exit code: ${data.returncode}`
          : `✗ Failed with exit code: ${data.returncode}`;
        status.className = success ? 'status status-success' : 'status status-error';

      } catch (err) {
        status.textContent = '✗ Request failed: ' + err.message;
        status.className = 'status status-error';
      }
    }

    // Utility functions
    function copyOutput() {
      const text = lastOutput.stdout;
      navigator.clipboard.writeText(text).then(() => {
        alert('Output copied to clipboard!');
      });
    }

    function downloadOutput() {
      const text = lastOutput.stdout;
      const blob = new Blob([text], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'fabric-output.txt';
      a.click();
      URL.revokeObjectURL(url);
    }

    function clearAll() {
      document.getElementById('inputText').value = '';
      document.getElementById('inputUrl').value = '';
      document.getElementById('youtubeUrl').value = '';
      document.getElementById('rawArgs').value = '';
      document.getElementById('patternSelect').selectedIndex = 0;
      document.getElementById('stdout').textContent = 'Output will appear here...';
      document.getElementById('stderr').textContent = 'Errors will appear here...';
      document.getElementById('status').textContent = '';
      updateCommandPreview();
    }

    function toggleSection(id) {
      const section = document.getElementById(id);
      const header = event.target;

      if (section.style.display === 'none') {
        section.style.display = 'block';
        header.classList.remove('collapsed');
      } else {
        section.style.display = 'none';
        header.classList.add('collapsed');
      }
    }

    // Initialize on load
    init();
  </script>
</body>
</html>
